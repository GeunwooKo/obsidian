# 실전 예제

## 예제 1: 간단한 CMOS 구조

### 공정 개요
1. 웰 형성
2. 게이트 산화막 성장
3. 폴리실리콘 증착 및 패터닝
4. S/D 이온주입
5. 절연막 증착 및 평탄화
6. 콘택 개구
7. 금속 배선

### 전체 스크립트
```ruby
# XS 파일: simple_cmos.xs

# 입력 레이어 정의
nwell_mask = layer("1/0")
active_mask = layer("2/0")
poly_mask = layer("3/0")
nplus_mask = layer("4/0")
pplus_mask = layer("5/0")
contact_mask = layer("6/0")
metal1_mask = layer("7/0")

# 기판 초기화
substrate = bulk

# 1. N-well 형성
nwell = mask(nwell_mask).grow(2.0, 1.0, :mode => :round, :into => substrate)

# 2. 게이트 산화막 (50nm)
gate_ox = deposit(0.05)

# 3. 폴리실리콘 증착 (200nm)
poly = deposit(0.2)

# 4. 폴리 식각 (패터닝)
poly_etch_mask = poly_mask.inverted
mask(poly_etch_mask).etch(0.25, 0.05, :mode => :round, 
                          :into => [poly, gate_ox, substrate])

# 5. S/D 이온주입
# N+ (NMOS 소스/드레인)
nplus = mask(nplus_mask).grow(0.15, 0.08, :mode => :round, 
                              :into => [substrate, nwell])

# P+ (PMOS 소스/드레인)
pplus = mask(pplus_mask).grow(0.15, 0.08, :mode => :round, 
                              :into => [substrate, nwell])

# 6. ILD (층간절연막) 증착
ild = deposit(0.6)

# 7. CMP 평탄화
planarize(:less => 0.4, :into => ild)

# 8. 콘택 개구
mask(contact_mask).etch(0.5, 0.02, :mode => :round, 
                        :into => ild)

# 9. 콘택 충진
contact = deposit(0.5)
planarize(:downto => ild, :into => contact)

# 10. 금속 배선
metal1 = mask(metal1_mask).grow(0.5, 0.1, :mode => :round)

# 출력
output("0/0", substrate)
output("1/0", nwell)
output("2/0", gate_ox)
output("3/0", poly)
output("4/0", nplus)
output("5/0", pplus)
output("6/0", ild)
output("7/0", contact)
output("8/0", metal1)
```

## 예제 2: 다층 금속 구조

### 공정 개요
- Metal 1-3층 구조
- Via 연결
- 각층 CMP 평탄화

```ruby
# 다층 금속 구조

# 기판 및 액티브 영역
substrate = bulk
active = mask(layer("1/0")).grow(0.3, :into => substrate)

# Metal 1
metal1_mask = layer("10/0")
via1_mask = layer("11/0")

ild1 = deposit(0.8)
planarize(:less => 0.5, :into => ild1)

mask(metal1_mask.inverted).etch(0.6, 0.05, :mode => :round, :into => ild1)
metal1 = deposit(0.4)
planarize(:downto => ild1, :into => metal1)

# Via 1
ild2 = deposit(0.6)
planarize(:less => 0.4, :into => ild2)

mask(via1_mask).etch(0.5, 0.02, :mode => :round, :into => ild2)
via1 = deposit(0.5)
planarize(:downto => ild2, :into => via1)

# Metal 2
metal2_mask = layer("20/0")
via2_mask = layer("21/0")

mask(metal2_mask.inverted).etch(0.5, 0.05, :mode => :round, :into => ild2)
metal2 = deposit(0.5)
planarize(:downto => ild2, :into => metal2)

# Via 2
ild3 = deposit(0.6)
planarize(:less => 0.4, :into => ild3)

mask(via2_mask).etch(0.5, 0.02, :mode => :round, :into => ild3)
via2 = deposit(0.5)
planarize(:downto => ild3, :into => via2)

# Metal 3 (Top metal)
metal3_mask = layer("30/0")
mask(metal3_mask.inverted).etch(0.5, 0.05, :mode => :round, :into => ild3)
metal3 = deposit(0.8)
planarize(:downto => ild3, :into => metal3)

# 패시베이션
passivation = deposit(1.0)

# 출력
output("0/0", substrate)
output("1/0", active)
output("10/0", metal1.or(via1))
output("20/0", metal2.or(via2))
output("30/0", metal3)
output("100/0", ild1.or(ild2).or(ild3))
output("101/0", passivation)
```

## 예제 3: TSV (Through Silicon Via)

### 공정 개요
1. 앞면: 금속 패드 형성
2. 뒷면: 테이퍼 식각
3. 금속 충진 및 평탄화
4. 뒷면 재배선

```ruby
# TSV 공정

# 웨이퍼 두께 설정 (100 µm)
depth(100)
extend(5)

# 앞면 공정
# ============

# 입력 레이어
pad_mask = layer("1/0")
tsv_mask = layer("2/0")

substrate = bulk

# 절연막
oxide1 = deposit(0.5)

# 금속 패드
mask(pad_mask.inverted).etch(0.6, 0.05, :mode => :round, :into => oxide1)
pad_metal = deposit(0.5)
planarize(:downto => oxide1, :into => pad_metal)

# 패시베이션
passivation = deposit(1.0)

# 뒷면 공정
# ============
flip

# TSV 식각 (테이퍼 4도)
mask(tsv_mask).etch(100, :taper => 4, :into => substrate)

# 절연막 라이너
barrier = deposit(0.1, 0.1, :mode => :round)

# 금속 충진 (구리)
tsv_metal = deposit(50)

# 뒷면 평탄화
planarize(:downto => substrate, :into => [tsv_metal, barrier])

# 뒷면 재배선층
rdl_oxide = deposit(2.0)
planarize(:less => 1.5, :into => rdl_oxide)

rdl_mask = layer("3/0")
mask(rdl_mask.inverted).etch(1.6, 0.1, :mode => :round, :into => rdl_oxide)
rdl_metal = deposit(1.0)
planarize(:downto => rdl_oxide, :into => rdl_metal)

# 범프 (solder bump)
bump_mask = layer("4/0")
bump = mask(bump_mask).grow(5.0, 2.0, :mode => :round)

# 출력
output("0/0", substrate)
output("1/0", pad_metal.or(tsv_metal).or(rdl_metal))
output("2/0", oxide1.or(rdl_oxide))
output("3/0", passivation)
output("4/0", barrier)
output("5/0", bump)
```

## 예제 4: MEMS 구조

### 공정 개요
- 희생층 (Sacrificial layer)
- 구조층 (Structural layer)
- 릴리즈 (Release)

```ruby
# MEMS 캔틸레버 구조

substrate = bulk

# 1. 앵커 영역 정의
anchor_mask = layer("1/0")
anchor = mask(anchor_mask).grow(0.3, :into => substrate)

# 2. 희생층 증착
sacrificial = deposit(2.0)

# 3. 앵커 개구
mask(anchor_mask).etch(2.1, 0.05, :mode => :round, :into => sacrificial)

# 4. 구조층 증착 (폴리실리콘)
structural_mask = layer("2/0")
structural = mask(structural_mask).grow(1.0, 0.1, :mode => :round)

# 5. 희생층 제거 (릴리즈)
# 측면에서만 식각 (buried 옵션 활용)
release_mask = layer("3/0")
mask(release_mask).etch(2.0, 1.0, :mode => :round, 
                        :into => sacrificial, :buried => 1.0)

# 출력
output("0/0", substrate)
output("1/0", anchor)
output("2/0", sacrificial)
output("3/0", structural)
```

## 예제 5: 트렌치 절연 (STI)

### 공정 개요
- 트렌치 식각
- 산화막 충진
- CMP 평탄화

```ruby
# STI (Shallow Trench Isolation)

# 입력 레이어
active_mask = layer("1/0")
substrate = bulk

# 1. 패드 산화막 + 질화막
pad_ox = deposit(0.01)
nitride = deposit(0.08)

# 2. 질화막 패터닝
mask(active_mask).etch(0.09, 0.01, :mode => :round, 
                       :into => [nitride, pad_ox])

# 3. 트렌치 식각 (깊이 0.3 µm)
mask(active_mask).etch(0.3, 0.05, :mode => :round, :into => substrate)

# 4. 라이너 산화막
liner = deposit(0.02, 0.02, :mode => :round)

# 5. 트렌치 충진
fill_ox = deposit(0.5)

# 6. CMP (질화막까지)
planarize(:downto => nitride, :into => [fill_ox, liner])

# 7. 질화막 제거
all.etch(0.1, :into => nitride)

# 8. 패드 산화막 제거
all.etch(0.02, :into => pad_ox)

# 출력
output("0/0", substrate)
output("1/0", liner.or(fill_ox))
output("2/0", nitride)
```

## 예제 6: FinFET 구조

### 공정 개요
- 핀 형성
- 게이트 산화막 및 게이트 형성
- S/D 에피택시

```ruby
# FinFET 구조 (단순화)

# 입력 레이어
fin_mask = layer("1/0")
gate_mask = layer("2/0")
sd_mask = layer("3/0")

substrate = bulk

# 1. 핀 식각
fin_etch_mask = fin_mask.inverted
mask(fin_etch_mask).etch(0.15, 0.02, :mode => :round, :into => substrate)

# 2. STI 충진
sti = deposit(0.2)
planarize(:less => 0.05, :into => sti)

# 3. 게이트 스택
gate_ox = deposit(0.003)  # 3nm
gate_metal = deposit(0.05)
poly_gate = deposit(0.1)

# 4. 게이트 패터닝
gate_etch_mask = gate_mask.inverted
mask(gate_etch_mask).etch(0.16, 0.02, :mode => :round,
                          :into => [poly_gate, gate_metal, gate_ox, substrate])

# 5. S/D 에피택시 (선택적 성장)
sd_epi = mask(sd_mask).grow(0.08, 0.05, :mode => :round, 
                            :on => substrate)

# 6. ILD
ild = deposit(0.3)
planarize(:less => 0.2, :into => ild)

# 출력
output("0/0", substrate)
output("1/0", sti)
output("2/0", gate_ox)
output("3/0", gate_metal)
output("4/0", poly_gate)
output("5/0", sd_epi)
output("6/0", ild)
```

## 예제 7: 단계별 디버깅 스크립트

### Snapshot을 활용한 공정 확인

```ruby
# 단계별 확인 스크립트

substrate = bulk

# Step 1: 웰 형성
nwell_mask = layer("1/0")
nwell = mask(nwell_mask).grow(2.0, 1.0, :mode => :round, :into => substrate)
output("0/0", substrate)
output("1/0", nwell)
snapshot("Step 1: N-Well Formation")

# Step 2: 게이트 스택
gate_ox = deposit(0.05)
poly = deposit(0.2)
output("2/0", gate_ox)
output("3/0", poly)
snapshot("Step 2: Gate Stack")

# Step 3: 게이트 패터닝
poly_mask = layer("3/0")
poly_etch = poly_mask.inverted
mask(poly_etch).etch(0.25, 0.05, :mode => :round, :into => [poly, gate_ox, substrate])
output("2/0", gate_ox)
output("3/0", poly)
snapshot("Step 3: Gate Patterning")

# Step 4: S/D 이온주입
nplus_mask = layer("4/0")
nplus = mask(nplus_mask).grow(0.15, 0.08, :mode => :round, :into => [substrate, nwell])
output("4/0", nplus)
snapshot("Step 4: N+ Implant")

# Step 5: ILD
ild = deposit(0.6)
output("5/0", ild)
snapshot("Step 5: ILD Deposition")

# Step 6: CMP
planarize(:less => 0.4, :into => ild)
output("5/0", ild)
snapshot("Step 6: CMP")

# Step 7: 콘택
contact_mask = layer("6/0")
mask(contact_mask).etch(0.5, 0.02, :mode => :round, :into => ild)
contact = deposit(0.5)
planarize(:downto => ild, :into => contact)
output("6/0", contact)
snapshot("Step 7: Contact")
```

## 예제 8: Ruby 제어 구조 활용

### 반복문을 이용한 다층 구조

```ruby
# 자동화된 다층 금속 스택

substrate = bulk

# 금속 층 정의
METAL_LAYERS = [
  { layer: "10/0", thickness: 0.3, via: "11/0" },
  { layer: "20/0", thickness: 0.4, via: "21/0" },
  { layer: "30/0", thickness: 0.5, via: "31/0" },
  { layer: "40/0", thickness: 0.8, via: nil }  # Top metal
]

metals = []
vias = []
ilds = []

METAL_LAYERS.each_with_index do |metal_def, i|
  # ILD 증착
  ild_thick = 0.5 + i * 0.1
  ild = deposit(ild_thick)
  planarize(:less => ild_thick - 0.2, :into => ild)
  ilds << ild
  
  # 금속 트렌치
  metal_mask = layer(metal_def[:layer])
  mask(metal_mask.inverted).etch(metal_def[:thickness] + 0.1, 0.05, 
                                  :mode => :round, :into => ild)
  
  # 금속 충진
  metal = deposit(metal_def[:thickness])
  planarize(:downto => ild, :into => metal)
  metals << metal
  
  # Via (마지막 층 제외)
  if metal_def[:via]
    via_mask = layer(metal_def[:via])
    
    # Via ILD
    via_ild = deposit(0.4)
    planarize(:less => 0.3, :into => via_ild)
    ilds << via_ild
    
    # Via 개구
    mask(via_mask).etch(0.35, 0.02, :mode => :round, :into => via_ild)
    
    # Via 충진
    via = deposit(0.35)
    planarize(:downto => via_ild, :into => via)
    vias << via
  end
end

# 출력
output("0/0", substrate)

# 금속 레이어 병합
all_metals = metals[0]
vias.each { |v| all_metals = all_metals.or(v) }
metals[1..-1].each { |m| all_metals = all_metals.or(m) }
output("1/0", all_metals)

# ILD 병합
all_ild = ilds[0]
ilds[1..-1].each { |ild| all_ild = all_ild.or(ild) }
output("2/0", all_ild)
```

## 팁과 모범 사례

### 1. 레이어 명명 규칙
```ruby
# 명확한 이름 사용
active_area = layer("1/0")
poly_gate = layer("2/0")
metal1_pattern = layer("10/0")

# 피해야 할 이름
a = layer("1/0")  # ❌
l1 = layer("2/0")  # ❌
```

### 2. 재료 추적
```ruby
# 재료를 의미 있는 변수에 저장
substrate = bulk
gate_oxide = deposit(0.05)
poly_silicon = deposit(0.2)

# 나중에 쉽게 참조
mask(pattern).etch(0.25, :into => [poly_silicon, gate_oxide])
```

### 3. 단위 일관성
```ruby
# 모든 치수를 µm 단위로 통일
thickness = 0.5  # 500 nm = 0.5 µm
lateral = 0.1    # 100 nm = 0.1 µm

grow(thickness, lateral, :mode => :round)
```

### 4. 주석 활용
```ruby
# 공정 단계별 주석
# ==================
# FEOL (Front End Of Line)
# ==================

# 1. 웰 형성 (깊이 2 µm, 확산 1 µm)
nwell = mask(nwell_mask).grow(2.0, 1.0, :mode => :round, :into => substrate)

# 2. STI (깊이 0.3 µm)
# ...
```

### 5. 에러 방지
```ruby
# 재료 존재 확인 후 사용
if defined?(oxide)
  mask(pattern).etch(0.5, :into => oxide)
end

# :into 항상 명시
mask(pattern).etch(0.3, :into => substrate)  # ✅
# mask(pattern).etch(0.3)  # ❌
```

## 다음 단계

- [[06_참고자료]] - API 레퍼런스 및 추가 자료
- [[07_FAQ]] - 자주 묻는 질문

## 태그
#예제 #cmos #tsv #mems #finfet #실전
