# 고급 기능 및 유틸리티

## 평탄화 (Planarization)

특정 재료를 일정 레벨까지 제거하는 CMP(Chemical Mechanical Polishing) 공정 모델링:

### 기본 문법
```ruby
planarize(options...)
```

### 옵션

| 옵션 | 설명 |
|------|------|
| `:into` | (필수) 제거할 재료 (단일 또는 배열) |
| `:downto` | 정지 재료 - 이 재료의 최상단에서 정지 |
| `:less` | 재료 최상단에서 지정 거리만큼 위에서 정지 (µm) |
| `:to` | 절대 z 값에서 정지 (웨이퍼 표면 기준, µm) |

⚠️ `:downto`, `:less`, `:to`는 상호 배타적 (하나만 사용)

### 예제 1: 정지층까지 평탄화
```ruby
substrate = bulk
metal = deposit(1.1)

# 기판까지 금속 제거
planarize(:downto => substrate, :into => metal)
```

### 예제 2: 상대 깊이로 평탄화
```ruby
oxide = deposit(2.0)

# 최상단에서 0.5 µm 위에서 정지
planarize(:less => 0.5, :into => oxide)
```

### 예제 3: 절대 높이로 평탄화
```ruby
metal = deposit(3.0)

# z = 1.0 µm에서 정지 (웨이퍼 표면 기준)
planarize(:to => 1.0, :into => metal)
```

### 예제 4: 여러 재료 평탄화
```ruby
# 금속과 산화막 모두 제거
planarize(:less => 0.5, :into => [metal, oxide])
```

## 뒷면 공정 (Backside Processing)

### 웨이퍼 두께 설정
```ruby
# 웨이퍼 두께를 1 µm로 설정 (일반적으로 100-750 µm)
depth(1)
```

### 뒷면으로 전환
```ruby
flip  # 뒷면 공정 시작
# ... 뒷면 공정 ...
flip  # 앞면으로 복귀
```

### TSV 공정 예제
```ruby
# 웨이퍼 두께 설정
depth(100)

# 앞면 공정
m1 = layer("1/0")
metal1 = mask(m1).grow(0.3)

# 뒷면으로 전환
flip

# 뒷면 식각 (테이퍼 각도 4도)
via_mask = layer("2/0")
substrate = bulk
mask(via_mask).etch(100, :taper => 4, :into => substrate)

# 금속 충진
via_metal = deposit(110)
planarize(:downto => substrate, :into => via_metal)

# 출력
output("0/0", substrate)
output("1/0", metal1.or(via_metal))  # 양면 금속 병합
```

## 처리 윈도우 설정

### 높이 (Height)
```ruby
# 웨이퍼 상단 위 처리 윈도우 높이
height(2)  # 기본값: 2 µm
```

### 깊이 (Depth)
```ruby
# 웨이퍼 아래 처리 깊이 또는 웨이퍼 두께
depth(2)   # 기본값: 2 µm
```

### 하단 (Below)
```ruby
# 뒷면 공정용 하단 확장
below(2)   # 기본값: 2 µm
```

### 마진 (Extend)
```ruby
# 컷 라인 주변 샘플링 윈도우
extend(2)  # 기본값: 2 µm

# 큰 확산이나 바이어스 사용시 증가 필요
extend(5)
```

## 정밀도 제어

### 데이터베이스 단위 (DBU)
```ruby
# 계산 해상도 설정 (µm)
dbu(0.0001)  # 0.1 nm

# 현재 DBU의 1/10로 설정
dbu(0.1 * dbu)

# 현재 DBU 확인
current_dbu = dbu
```

⚠️ **주의**: DBU를 너무 작게 하면 좌표 오버플로우 발생 가능

### Delta 값
```ruby
# 정밀도 임계값 설정
delta(0.001)  # µm 단위

# 기본값: 10 DBU
```

**Delta의 역할**:
- 기하학적 영역의 정밀도 한계
- 작은 틈새나 슬리버 치유
- 이 값보다 작은 형상/간격 생성 불가

## 디버깅 도구

### Pause (일시정지)
```ruby
# 현재 상태 표시 후 계속 여부 확인
pause

# 메시지와 함께
pause("Step #17: Metal etch completed")
```

- 현재까지 `output`된 재료 표시
- 대화상자로 계속 여부 확인
- 스크립트 디버깅에 유용

### Snapshot (스냅샷)
```ruby
# 현재 상태 저장 후 새 탭에서 계속
snapshot

# 탭 이름 지정
snapshot("After metal deposition")
```

- 현재 상태를 탭에 저장
- 일시정지 없이 계속 진행
- 공정 단계별 비교에 유용

### Output을 통한 디버깅
```ruby
# 중간 상태 확인
metal = deposit(0.5)
output("100/0", metal)  # 디버그 레이어에 출력

# 식각 전 상태 확인
output("101/0", metal)
mask(pattern).etch(0.3, :into => metal)

# 식각 후 상태 확인
output("102/0", metal)
```

## 레이어 속성 파일

### .lyp 파일 로드
```ruby
# 레이어 색상, 패턴 등 설정
layers_file("/path/to/layers.lyp")

# 상대 경로 (xs 파일 기준)
layers_file("./layers.lyp")
```

## 의사 재료 (Pseudo Materials)

### bulk
```ruby
substrate = bulk  # 웨이퍼 기판
```
- 초기 웨이퍼 상태 표현
- 읽기 전용이므로 변수에 저장 필요
- 매 호출마다 새 객체 반환

### all
```ruby
# 전체 웨이퍼를 덮는 의사 마스크
oxide = all.grow(0.5)
# 또는
oxide = deposit(0.5)
```

## 전역 함수

### Uniform Deposit
```ruby
# 다음은 모두 동일
oxide = deposit(0.5)
oxide = grow(0.5)
oxide = diffuse(0.5)
oxide = all.grow(0.5)
```

### Uniform Etch
```ruby
# 전체 웨이퍼 식각
etch(0.3, :into => oxide)
# 또는
all.etch(0.3, :into => oxide)
```

## 재료 데이터 연산

재료도 레이어 데이터처럼 Boolean 연산 가능:

```ruby
metal1a = mask(l1).grow(0.1, 0.1, :mode => :round)
metal1b = mask(l2).grow(0.1, 0.1, :mode => :round)

# 두 금속 병합
combined_metal = metal1a.or(metal1b)

output("1/0", combined_metal)
```

## 실전 팁

### 1. 공정 단계별 확인
```ruby
# 각 단계 후 스냅샷
poly = mask(poly_mask).grow(0.2)
snapshot("Poly deposition")

mask(poly_mask.inverted).etch(0.3, :into => poly)
snapshot("Poly etch")

oxide = deposit(0.5)
snapshot("ILD deposition")

planarize(:less => 0.3, :into => oxide)
snapshot("CMP")
```

### 2. 복잡한 공정 플로우
```ruby
# 웨이퍼 설정
depth(100)
extend(5)
dbu(0.0005)  # 0.5 nm 해상도

# 기판 준비
substrate = bulk

# 앞면 공정
# ... (금속 1, 2, 3)

# 뒷면 공정
flip
# ... (TSV, 범프)
flip

# 최종 평탄화
# ...
```

### 3. 조건부 공정 (Ruby 활용)
```ruby
# 변수로 공정 제어
USE_CMP = true
METAL_THICKNESS = 0.5

metal = deposit(METAL_THICKNESS)

if USE_CMP
  planarize(:less => 0.1, :into => metal)
end
```

### 4. 반복 공정 (Ruby 활용)
```ruby
# 다층 금속
(1..5).each do |i|
  metal_layer = layer("#{i}/0")
  metal = mask(metal_layer).grow(0.3)
  
  oxide = deposit(0.5)
  planarize(:less => 0.3, :into => oxide)
  
  output("#{10+i}/0", metal)
  output("#{20+i}/0", oxide)
end
```

## 일반적인 문제 해결

### 문제 1: 경계 아티팩트
```ruby
# 원인: extend 값이 작음
grow(0.5, 0.3, ...)  # lateral > extend

# 해결: extend 증가
extend(1.0)
grow(0.5, 0.3, ...)
```

### 문제 2: 정밀도 문제
```ruby
# 원인: DBU가 너무 큼
# 해결: DBU 감소
dbu(0.0001)  # 0.1 nm
```

### 문제 3: 작은 형상 누락
```ruby
# 원인: delta 값이 너무 큼
# 해결: delta 감소
delta(0.0005)  # 0.5 nm
```

### 문제 4: 뒷면 공정 오류
```ruby
# 원인: 웨이퍼 두께 미설정
flip  # ❌ depth가 설정 안 됨

# 해결: depth 먼저 설정
depth(100)
flip  # ✅
```

## XSection의 한계

⚠️ **중요**: XSection은 단순화된 도구입니다:

1. **3D 시뮬레이터 아님**
   - 룰러 라인 밖 구조 영향 미반영
   - 복잡한 물리 현상 미모델링

2. **회피 방법**
   - 입력 레이어에 `size` 적용
   - `bias`로 보상
   - 하지만 완벽하지 않음

3. **적합한 용도**
   - 문서화용 이미지 생성
   - 교육 및 설명
   - 개념 검증

4. **부적합한 용도**
   - 정밀 공정 시뮬레이션
   - 정량적 분석
   - 실제 공정 예측

## 다음 단계

- [[05_실전_예제]] - 완전한 CMOS 공정 예제
- [[06_참고자료]] - API 레퍼런스 및 링크

## 태그
#planarize #backside #debugging #advanced
