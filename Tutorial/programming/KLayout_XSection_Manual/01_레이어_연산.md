# 레이어 연산 및 처리

## 레이어 가져오기

```ruby
# 레이어 1, 데이터타입 0 가져오기
l1 = layer("1/0")

# 레이어 이름으로 가져오기
metal = layer("METAL1")

# 파일에서 가져오기
pattern = layer("pattern.gds", "1/0")
```

## Boolean 연산

### OR (병합)
```ruby
l1 = layer("1/0")
l2 = layer("2/0")
p1 = l1.or(l2)  # 두 레이어의 합집합
```

### AND (교집합)
```ruby
p2 = l1.and(l2)  # 두 레이어의 교집합
```

### XOR (대칭 차집합)
```ruby
p3 = l1.xor(l2)  # 두 레이어의 대칭 차집합
```

### NOT (차집합)
```ruby
p = l1.not(l2)  # l1에서 l2를 뺀 결과
```

## Boolean 연산 진리표

| a | b | a.or(b) | a.and(b) | a.xor(b) | a.not(b) |
|---|---|---------|----------|----------|----------|
| ⬜ | ⬜ | ⬜ | ⬜ | ⬜ | ⬜ |
| ⬛ | ⬜ | ⬛ | ⬜ | ⬛ | ⬛ |
| ⬜ | ⬛ | ⬛ | ⬜ | ⬛ | ⬜ |
| ⬛ | ⬛ | ⬛ | ⬛ | ⬜ | ⬜ |

## 크기 조정 (Sizing/Biasing)

### 등방성 크기 조정
```ruby
l1 = layer("1/0")

# 0.2 µm 확장 (in-place)
l1.size(0.2)

# 0.2 µm 확장 (복사본 생성)
p = l1.sized(0.2)
```

### 비등방성 크기 조정
```ruby
# x 방향 0.1 µm, y 방향 0 µm 확장
l1.size(0.1, 0)

# 복사본으로 생성
p = l1.sized(0.1, 0)
```

### 크기 조정 효과

- **양수 값**: 도형을 외부로 확장 (선폭은 2배 증가)
- **음수 값**: 도형을 내부로 축소 (선폭은 2배 감소)
- 음수 값은 도형을 완전히 또는 부분적으로 제거할 수 있음

## 레이어 반전 (Inversion)

### In-place 반전
```ruby
l1 = layer("1/0")
l1.invert  # l1을 직접 수정
metal = mask(l1).grow(0.3)
```

### Out-of-place 반전
```ruby
l1 = layer("1/0")
l1_inv = l1.inverted  # 반전된 복사본 생성
metal = mask(l1_inv).grow(0.3)
# l1은 여전히 원본 상태
```

## 중요한 개념: 참조 vs 복사

⚠️ **주의**: Ruby에서 변수 할당은 복사가 아닌 참조를 생성합니다!

```ruby
# 잘못된 예
a = layer("1/0")
b = a
a.invert  # b도 함께 반전됨!

# 올바른 방법 1: out-of-place 메서드 사용
b = layer("1/0")
a = b.inverted

# 올바른 방법 2: dup 메서드로 복사
a = layer("1/0")
b = a.dup
a.invert  # 이제 b는 영향받지 않음
```

## 마스크 생성

레이어 데이터를 마스크로 변환:

```ruby
l1 = layer("1/0")
mask_data = mask(l1)

# 마스크를 사용한 공정
metal = mask_data.grow(0.3)
```

## 실전 예제

### 마스크 극성 반전을 통한 식각
```ruby
# 입력 레이어
m1 = layer("1/0")

# 반전 (그려진 부분이 아닌 곳을 식각하기 위해)
m1i = m1.inverted

# 금속 증착
metal1 = deposit(0.25)
substrate = bulk

# 반전된 마스크로 식각
mask(m1i).etch(0.3, 0.1, :mode => :round, :into => [metal1, substrate])

# 출력
output("0/0", substrate)
output("1/0", metal1)
```

### 복합 마스크 생성
```ruby
# 두 레이어 가져오기
active = layer("1/0")
poly = layer("2/0")

# 게이트 영역 = active AND poly
gate = active.and(poly)

# 소스/드레인 = active NOT poly
sd = active.not(poly)

# 각각 다른 공정 적용
gate_metal = mask(gate).grow(0.1)
sd_implant = mask(sd).grow(0.2, 0.05, :mode => :round)
```

## 팁과 트릭

1. **가독성**: 변수에 의미 있는 이름 사용
2. **디버깅**: 중간 결과를 output으로 확인
3. **재사용**: 자주 사용하는 패턴은 변수에 저장

## 다음 단계

- [[02_Grow_메서드]] - 증착 및 재료 변환의 세부사항
- [[03_Etch_메서드]] - 식각 공정의 다양한 옵션

## 태그
#레이어연산 #boolean #sizing #마스크
